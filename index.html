<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="theme-color" content="#0d0f14"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Inventario"/>
<link rel="manifest" href="data:application/json;charset=utf-8,{
  &quot;name&quot;: &quot;Inventario&quot;,
  &quot;short_name&quot;: &quot;Inventario&quot;,
  &quot;description&quot;: &quot;App de inventario offline&quot;,
  &quot;start_url&quot;: &quot;.&quot;,
  &quot;display&quot;: &quot;standalone&quot;,
  &quot;background_color&quot;: &quot;#0d0f14&quot;,
  &quot;theme_color&quot;: &quot;#00e87a&quot;,
  &quot;orientation&quot;: &quot;portrait&quot;,
  &quot;icons&quot;: [
    {&quot;src&quot;: &quot;data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230d0f14'/><text y='.9em' font-size='80'>üì¶</text></svg>&quot;, &quot;sizes&quot;: &quot;any&quot;, &quot;type&quot;: &quot;image/svg+xml&quot;}
  ]
}"/>

<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventario</title>
<style>
/* Fuentes del sistema - funciona offline */

:root {
  --bg: #0d0f14;
  --surface: #161922;
  --surface2: #1e2330;
  --border: #2a3040;
  --accent: #00e87a;
  --accent2: #00b85e;
  --red: #ff3b3b;
  --text: #e8eaf0;
  --text2: #8a92a8;
  --text3: #555d72;
  --warning: #ffb800;
  --radius: 10px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  min-height: 100vh;
}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none; }
.screen.active { display: block; }
#screen-login.active { display: flex; }

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
#screen-login {
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 24px;
}
.login-box {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 40px 36px;
  width: 100%;
  max-width: 380px;
}
.login-logo {
  text-align: center;
  margin-bottom: 28px;
}
.login-logo .emoji { font-size: 48px; }
.login-logo h1 { font-size: 22px; font-weight: 800; letter-spacing: 3px; margin-top: 8px; }
.login-logo p { color: var(--text2); font-size: 12px; letter-spacing: 1px; }

.input-group { margin-bottom: 14px; }
.input-group input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 14px;
  padding: 12px 16px;
  outline: none;
  transition: border-color .2s;
}
.input-group input:focus { border-color: var(--accent); }

.btn {
  display: block;
  width: 100%;
  padding: 13px 20px;
  border: none;
  border-radius: var(--radius);
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: opacity .15s, transform .1s;
  letter-spacing: .5px;
}
.btn:active { transform: scale(.98); }
.btn-primary { background: var(--accent); color: #000; }
.btn-primary:hover { opacity: .9; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); margin-top: 10px; }
.btn-outline:hover { border-color: var(--text2); color: var(--text); }
.btn-danger { background: var(--red); color: #fff; }
.btn-warn { background: var(--surface2); color: var(--warning); border: 1px solid var(--warning); }

.divider { text-align: center; color: var(--text3); font-size: 12px; margin: 12px 0; }
.login-hint { text-align: center; color: var(--text3); font-size: 11px; margin-top: 16px; }

/* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 10;
}
.topbar-left { display: flex; align-items: center; gap: 10px; }
.topbar-left .back-btn {
  background: none;
  border: none;
  color: var(--text2);
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: background .15s;
}
.topbar-left .back-btn:hover { background: var(--surface2); }
.topbar-title { font-weight: 700; font-size: 15px; }
.topbar-right { display: flex; align-items: center; gap: 8px; }
.session-badge {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 4px 10px;
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 11px;
  color: var(--text2);
}
.dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
.dot.red { background: var(--red); }

/* ‚îÄ‚îÄ MAIN LIST ‚îÄ‚îÄ */
.main-content { padding: 16px 20px; max-width: 600px; margin: 0 auto; }

.session-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.session-card .label { font-size: 11px; color: var(--text3); letter-spacing: .5px; text-transform: uppercase; }
.session-card .val { font-family: 'Courier New', 'Consolas', monospace; font-size: 14px; color: var(--accent); margin-top: 2px; }
.session-card .change-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text3);
  font-size: 11px;
  padding: 5px 10px;
  border-radius: 6px;
  cursor: pointer;
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
}
.session-card .change-btn:hover { border-color: var(--red); color: var(--red); }

.action-buttons { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.action-buttons .btn { flex: 1; min-width: 140px; padding: 11px 14px; font-size: 12px; letter-spacing: .5px; }

.area-list { display: flex; flex-direction: column; gap: 8px; }
.area-item {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  text-decoration: none;
  color: var(--text);
}
.area-item:hover { border-color: var(--accent); background: var(--surface2); }
.area-item-left { display: flex; align-items: center; gap: 12px; }
.area-icon { font-size: 18px; }
.area-name { font-weight: 600; font-size: 14px; }
.area-sub { font-size: 11px; color: var(--text3); margin-top: 2px; font-family: 'Courier New', 'Consolas', monospace; }
.area-right { display: flex; align-items: center; gap: 10px; }
.area-kg {
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 12px;
  color: var(--accent);
  background: rgba(0,232,122,.08);
  padding: 3px 8px;
  border-radius: 6px;
}
.area-kg.zero { color: var(--text3); background: none; }
.chevron { color: var(--text3); font-size: 14px; }

/* ‚îÄ‚îÄ AREA SCREEN ‚îÄ‚îÄ */
.mic-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 24px 20px 16px;
}
.mic-btn {
  width: 72px;
  height: 72px;
  border-radius: 50%;
  border: 3px solid var(--red);
  background: rgba(255,59,59,.12);
  color: var(--red);
  font-size: 26px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all .2s;
  position: relative;
}
.mic-btn.recording {
  border-color: var(--accent);
  background: rgba(0,232,122,.15);
  color: var(--accent);
  box-shadow: 0 0 0 0 rgba(0,232,122,.4);
  animation: pulse 1.4s infinite;
}
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(0,232,122,.4); }
  70% { box-shadow: 0 0 0 16px rgba(0,232,122,0); }
  100% { box-shadow: 0 0 0 0 rgba(0,232,122,0); }
}
.mic-status { font-size: 11px; color: var(--text3); margin-top: 8px; letter-spacing: .5px; }
.transcript-box {
  width: 100%;
  max-width: 560px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  font-size: 12px;
  color: var(--text2);
  font-family: 'Courier New', 'Consolas', monospace;
  min-height: 40px;
  margin-top: 10px;
  line-height: 1.6;
}

/* ‚îÄ‚îÄ MANUAL FORM ‚îÄ‚îÄ */
.form-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin: 0 20px 16px;
  max-width: 560px;
  margin-left: auto;
  margin-right: auto;
}
.form-section h3 { font-size: 11px; letter-spacing: 1px; color: var(--text3); text-transform: uppercase; margin-bottom: 12px; }
.form-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
.form-field { flex: 1; min-width: 100px; }
.form-field label { display: block; font-size: 10px; color: var(--text3); letter-spacing: .5px; margin-bottom: 4px; text-transform: uppercase; }
.form-field input, .form-field select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 7px;
  color: var(--text);
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 13px;
  padding: 9px 12px;
  outline: none;
  transition: border-color .2s;
}
.form-field input:focus, .form-field select:focus { border-color: var(--accent); }
.form-field select option { background: var(--surface2); }
.total-preview {
  background: var(--surface2);
  border-radius: 7px;
  padding: 9px 12px;
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 13px;
  color: var(--accent);
  border: 1px solid var(--border);
  white-space: nowrap;
}

/* ‚îÄ‚îÄ RECORDS ‚îÄ‚îÄ */
.records-section { padding: 0 20px 20px; max-width: 600px; margin: 0 auto; }
.records-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 10px 14px;
  flex-wrap: nowrap;
  gap: 8px;
}
.records-header .label { font-size: 11px; color: var(--text3); letter-spacing: .5px; text-transform: uppercase; white-space: nowrap; }
.records-header .totals { font-family: 'Courier New', 'Consolas', monospace; font-size: 12px; color: var(--accent); white-space: nowrap; text-align: right; }
.record-list { border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); }
.record-item {
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 8px;
  align-items: center;
  padding: 10px 14px;
  border-bottom: 1px solid var(--border);
  font-size: 12px;
}
.record-item:last-child { border-bottom: none; }
.record-prod { font-weight: 600; }
.record-envase { font-family: 'Courier New', 'Consolas', monospace; color: var(--text2); font-size: 11px; }
.record-qty { font-family: 'Courier New', 'Consolas', monospace; color: var(--text2); font-size: 11px; text-align: right; }
.record-kg { font-family: 'Courier New', 'Consolas', monospace; color: var(--accent); font-size: 12px; text-align: right; }
.record-del {
  background: none;
  border: none;
  color: var(--text3);
  cursor: pointer;
  font-size: 14px;
  padding: 2px 6px;
  border-radius: 4px;
  transition: color .15s;
}
.record-del:hover { color: var(--red); }
.empty-state {
  text-align: center;
  padding: 30px;
  color: var(--text3);
  font-size: 13px;
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius) var(--radius);
}
.empty-state p:last-child { font-size: 11px; margin-top: 4px; }

/* ‚îÄ‚îÄ SUMMARY SCREEN ‚îÄ‚îÄ */
.summary-content { padding: 20px; max-width: 600px; margin: 0 auto; }
.export-group { margin-bottom: 24px; }
.export-group h3 { font-size: 11px; letter-spacing: 1px; color: var(--text3); text-transform: uppercase; margin-bottom: 10px; }
.export-row { display: flex; gap: 10px; }
.export-row .btn { flex: 1; padding: 13px; font-size: 13px; }
.btn-pdf { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.btn-pdf:hover { border-color: var(--text2); }
.btn-excel { background: var(--surface2); border: 1px solid var(--border); color: var(--text); }
.btn-excel:hover { border-color: var(--accent); }

.summary-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 12px; }
.summary-table th {
  background: var(--surface2);
  border: 1px solid var(--border);
  padding: 8px 12px;
  text-align: left;
  font-size: 10px;
  letter-spacing: .5px;
  color: var(--text3);
  text-transform: uppercase;
}
.summary-table td {
  border: 1px solid var(--border);
  padding: 8px 12px;
  font-family: 'Courier New', 'Consolas', monospace;
}
.summary-table tr:hover td { background: var(--surface2); }
.summary-table .num { text-align: right; color: var(--accent); }
.summary-table .total-row td { background: var(--surface2); font-weight: 700; color: var(--text); }

.danger-zone { margin-top: 24px; }
.danger-zone h3 { font-size: 11px; letter-spacing: 1px; color: var(--red); text-transform: uppercase; margin-bottom: 10px; opacity: .7; }

/* ‚îÄ‚îÄ DIALOG ‚îÄ‚îÄ */
.dialog-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 20px;
  display: none;
}
.dialog-overlay.open { display: flex; }
.dialog {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 24px;
  width: 100%;
  max-width: 400px;
}
.dialog h3 { font-size: 15px; margin-bottom: 8px; }
.dialog p { color: var(--text2); font-size: 13px; margin-bottom: 16px; line-height: 1.5; }
.dialog-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; max-height: 50vh; overflow-y: auto; }
.dialog-option {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  cursor: pointer;
  font-size: 13px;
  transition: border-color .15s;
  text-align: left;
  color: var(--text);
  font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
}
.dialog-option:hover { border-color: var(--accent); }
.dialog-option .num { color: var(--accent); font-family: 'Courier New', 'Consolas', monospace; margin-right: 6px; }
.dialog-actions { display: flex; gap: 8px; }
.dialog-actions .btn { flex: 1; padding: 10px; font-size: 12px; }

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 20px;
  font-size: 13px;
  z-index: 200;
  transition: transform .3s;
  white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { border-color: var(--accent); color: var(--accent); }
.toast.error { border-color: var(--red); color: var(--red); }

/* ‚îÄ‚îÄ CATALOG IMPORT ‚îÄ‚îÄ */
#catalog-import-input { display: none; }

/* ‚îÄ‚îÄ QUICK FORM (embebido en √°rea) ‚îÄ‚îÄ */
.quick-form {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px 16px;
  max-width: 600px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.qf-label {
  display: block;
  font-size: 10px;
  color: var(--text3);
  letter-spacing: .8px;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.qf-input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 14px;
  padding: 10px 13px;
  outline: none;
  transition: border-color .2s;
}
.qf-input:focus { border-color: var(--accent); }
.qf-row { display: flex; gap: 8px; align-items: flex-end; }
.qf-total {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 13px;
  font-family: 'Courier New', 'Consolas', monospace;
  font-size: 14px;
  color: var(--accent);
  white-space: nowrap;
  min-width: 72px;
  text-align: center;
}
.qf-field-wrap { display: flex; flex-direction: column; }
.new-badge {
  font-size: 11px;
  color: var(--warning);
  margin-top: 5px;
  padding: 4px 10px;
  background: rgba(255,184,0,.08);
  border: 1px solid rgba(255,184,0,.25);
  border-radius: 6px;
}

/* ‚îÄ‚îÄ AUTOCOMPLETE DROPDOWN ‚îÄ‚îÄ */
.ac-wrap { position: relative; }
.ac-dropdown {
  position: absolute;
  top: calc(100% + 4px);
  left: 0; right: 0;
  background: var(--surface);
  border: 1px solid var(--accent);
  border-radius: 8px;
  z-index: 50;
  max-height: 220px;
  overflow-y: auto;
  display: none;
  box-shadow: 0 8px 24px rgba(0,0,0,.4);
}
.ac-dropdown.open { display: block; }
.ac-item {
  padding: 10px 14px;
  font-size: 13px;
  font-family: 'Courier New', 'Consolas', monospace;
  cursor: pointer;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  transition: background .1s;
}
.ac-item:last-child { border-bottom: none; }
.ac-item:hover, .ac-item.selected { background: var(--surface2); }
.ac-item mark {
  background: none;
  color: var(--accent);
  font-weight: 700;
}
.ac-item-new {
  color: var(--warning);
  font-style: italic;
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-login" class="screen active">
  <div class="login-box">
    <div class="login-logo">
      <div class="emoji">üì¶</div>
      <h1>INVENTARIO</h1>
      <p>Inventario de frutas y verduras ¬∑ Offline</p>
    </div>
    <div class="input-group">
      <input type="text" id="session-input" placeholder="C√≥digo de sesi√≥n" autocomplete="off" spellcheck="false"/>
    </div>
    <button class="btn btn-primary" onclick="enterSession()">Entrar ‚Üí</button>
    <div class="divider">o</div>
    <button class="btn btn-outline" onclick="randomSession()">Crear sesi√≥n nueva aleatoria</button>
    <p class="login-hint">Todos los dispositivos con el mismo c√≥digo comparten los datos.<br>Pod√©s usar letras y n√∫meros, sin espacios.</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-main" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <span class="emoji">üì¶</span>
      <span class="topbar-title">Inventario</span>
    </div>
    <div class="topbar-right">
      <span class="session-badge" id="main-session-label">‚Äî</span>
      <div class="dot" id="main-dot"></div>
    </div>
  </div>
  <div class="main-content">
    <div class="session-card">
      <div>
        <div class="label">Sesi√≥n activa</div>
        <div class="val" id="main-session-val">‚Äî</div>
      </div>
      <button class="change-btn" onclick="changeSession()">‚úï Cambiar</button>
    </div>
    <div class="action-buttons">
      <button class="btn btn-outline" onclick="goToSummary()">üìä Resumen Global</button>
      <button class="btn btn-outline" onclick="goToSummaryByArea()">üìÇ Resumen por √Årea</button>
    </div>
    <div class="action-buttons">
      <label class="btn btn-outline" style="text-align:center;cursor:pointer;" for="catalog-import-input">üìã Importar Cat√°logo</label>
      <input type="file" id="catalog-import-input" accept=".xlsx,.csv,.txt" onchange="importCatalog(event)"/>
    </div>
    <div class="area-list" id="area-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AREA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-area" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <button class="back-btn" onclick="goBack('screen-main')">‚Üê</button>
      <span class="topbar-title" id="area-title" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;">√Årea</span>
    </div>
    <div class="topbar-right" style="gap:6px;">
      <span id="area-kg-bar" style="font-family:'Courier New',monospace;font-size:12px;color:var(--accent);white-space:nowrap;">0 kg</span>
    </div>
  </div>

  <!-- Formulario de carga r√°pida embebido -->
  <div class="quick-form" id="quick-form">
    <div class="qf-field-wrap">
      <label class="qf-label">Producto</label>
      <div class="ac-wrap" id="ac-producto-wrap">
        <input type="text" id="qf-producto" class="qf-input" placeholder="Busc√° o escrib√≠ el producto‚Ä¶"
          autocomplete="off" spellcheck="false"
          oninput="acFilter('producto')" onfocus="acFilter('producto')" onblur="acBlur('producto')"/>
        <div class="ac-dropdown" id="ac-producto-list"></div>
      </div>
      <div id="qf-new-badge" class="new-badge" style="display:none;">‚äï Producto nuevo ‚Äî se agregar√° al cat√°logo</div>
    </div>
    <div class="qf-field-wrap">
      <label class="qf-label">Envase / Presentaci√≥n</label>
      <div class="ac-wrap" id="ac-envase-wrap">
        <input type="text" id="qf-envase" class="qf-input" placeholder="Ej: Reja 15 kg, Caja 20 kg‚Ä¶"
          autocomplete="off" spellcheck="false"
          oninput="acFilter('envase')" onfocus="acFilter('envase')" onblur="acBlur('envase')"/>
        <div class="ac-dropdown" id="ac-envase-list"></div>
      </div>
    </div>
    <div class="qf-row">
      <div class="qf-field-wrap" style="flex:1">
        <label class="qf-label">Cantidad</label>
        <input type="number" id="qf-cant" class="qf-input" placeholder="0" min="0" inputmode="numeric" oninput="qfCalc()"/>
      </div>
      <div class="qf-field-wrap" style="flex:1">
        <label class="qf-label">kg / envase</label>
        <input type="number" id="qf-kgenv" class="qf-input" placeholder="0" min="0" step="0.1" inputmode="decimal" oninput="qfCalc()"/>
      </div>
      <div class="qf-field-wrap" style="flex:0 0 auto;">
        <label class="qf-label">Total</label>
        <div class="qf-total" id="qf-total">0 kg</div>
      </div>
    </div>
    <button class="btn btn-primary" style="width:100%;margin-top:4px;" onclick="qfSave()">‚úì Guardar registro</button>
  </div>

  <div class="records-section">
    <div class="records-header" style="display:flex;justify-content:space-between;align-items:center;">
      <span class="label">Registros</span>
      <span class="totals" id="area-totals">0 items ¬∑ 0 kg</span>
    </div>
    <div id="record-list"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUMMARY GLOBAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-summary" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <button class="back-btn" onclick="goBack('screen-main')">‚Üê</button>
      <span class="topbar-title">Resumen Global</span>
    </div>
  </div>
  <div class="summary-content">
    <div class="export-group">
      <h3>Exportar Resumen Global</h3>
      <div class="export-row">
        <button class="btn btn-pdf" onclick="exportPDF('global')">üìÑ PDF Global</button>
        <button class="btn btn-excel" onclick="exportExcel('global')">üìä Excel Global</button>
      </div>
    </div>
    <div class="danger-zone">
      <h3>Zona peligrosa</h3>
      <button class="btn btn-danger" onclick="clearAll()" style="margin-bottom:8px">‚ö† Borrar Todo el Inventario</button>
    </div>
    <table class="summary-table" id="global-table">
      <thead>
        <tr>
          <th>Producto</th>
          <th style="text-align:right">Envases</th>
          <th style="text-align:right">Total kg</th>
        </tr>
      </thead>
      <tbody id="global-tbody"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUMMARY BY AREA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screen-summary-area" class="screen">
  <div class="topbar">
    <div class="topbar-left">
      <button class="back-btn" onclick="goBack('screen-main')">‚Üê</button>
      <span class="topbar-title">Resumen por √Årea</span>
    </div>
  </div>
  <div class="summary-content">
    <div class="export-group">
      <h3>Exportar por √Årea</h3>
      <div class="export-row">
        <button class="btn btn-pdf" onclick="exportPDF('area')">üìÑ PDF por √Årea</button>
        <button class="btn btn-excel" onclick="exportExcel('area')">üìä Excel por √Årea</button>
      </div>
    </div>
    <div class="danger-zone">
      <h3>Zona peligrosa</h3>
      <button class="btn btn-warn" onclick="clearByArea()">üóë Borrar por √Årea</button>
    </div>
    <div id="area-summary-content"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DIALOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="dialog-overlay" id="dialog-overlay">
  <div class="dialog">
    <h3 id="dialog-title">Producto no encontrado</h3>
    <p id="dialog-msg">¬øQuisiste decir alguno de estos?</p>
    <div class="dialog-options" id="dialog-options"></div>
    <div class="dialog-actions">
      <button class="btn btn-outline" onclick="closeDialog()">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmDialogNew()">Agregar como nuevo</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCRIPTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// SheetJS - carga desde CDN con fallback offline
(function() {
  var s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  s.onerror = function() {
    // Fallback: deshabilitar exportaci√≥n Excel, solo PDF disponible
    window.XLSX = {
      utils: {
        book_new: function() { return {SheetNames:[], Sheets:{}}; },
        aoa_to_sheet: function() { return {}; },
        book_append_sheet: function() {},
        sheet_to_json: function() { return []; }
      },
      read: function() { return {SheetNames:[''], Sheets:{'':{}} }; },
      writeFile: function() {
        alert('Exportaci√≥n Excel no disponible offline. Usa la opci√≥n PDF o conectate a internet una vez para activar esta funci√≥n.');
      }
    };
  };
  document.head.appendChild(s);
})();
</script>
<script>

// ‚îÄ‚îÄ CATALOG ‚îÄ‚îÄ
const BASE_CATALOG = [
  "Tomate Bola","Tomate Saladette","Cebolla Blanca","Cebolla Morada",
  "Lechuga Romana","Lechuga Sangr√≠a","Manzana Red Delicious","Manzana Granny Smith",
  "Chile Poblano","Chile Habanero","Aguacate","Pl√°tano","Zanahoria","Br√≥coli",
  "Espinaca","Calabacita","Pepino","Sand√≠a","Papaya","Mango"
];
let CATALOG = [...BASE_CATALOG];

// ‚îÄ‚îÄ AREAS ‚îÄ‚îÄ
const AREAS = [
  { id: "camara1", name: "C√°mara 1", icon: "‚ùÑÔ∏è" },
  { id: "camara2", name: "C√°mara 2", icon: "‚ùÑÔ∏è" },
  { id: "camara3", name: "C√°mara 3", icon: "‚ùÑÔ∏è" },
  { id: "camara4", name: "C√°mara 4", icon: "‚ùÑÔ∏è" },
  { id: "camara5", name: "C√°mara 5", icon: "‚ùÑÔ∏è" },
  { id: "deposito_secos", name: "Dep√≥sito Secos", icon: "üì¶" },
  { id: "bodega", name: "Bodega", icon: "üèõÔ∏è" },
  { id: "playon", name: "Play√≥n", icon: "üèóÔ∏è" },
];

// ‚îÄ‚îÄ CATALOG PERSISTENCE ‚îÄ‚îÄ
function loadCustomCatalog() {
  try {
    const saved = localStorage.getItem('inv_custom_catalog');
    if (saved) {
      const extra = JSON.parse(saved);
      extra.forEach(p => { if (!CATALOG.includes(p)) CATALOG.push(p); });
    }
  } catch(e) {}
}

function addToCatalog(producto) {
  const nombre = producto.trim();
  if (!nombre) return;
  const ya = CATALOG.find(p => normalize(p) === normalize(nombre));
  if (ya) return; // ya existe
  CATALOG.push(nombre);
  CATALOG.sort();
  // Guardar los productos custom en localStorage (solo los que no son base)
  try {
    const custom = CATALOG.filter(p => !BASE_CATALOG.includes(p));
    localStorage.setItem('inv_custom_catalog', JSON.stringify(custom));
  } catch(e) {}
  updateDatalist();
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let session = "";
let currentArea = null;
let dialogCallback = null;

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function storageKey(k) { return `inv_${session}_${k}`; }

function getData(areaId) {
  try {
    return JSON.parse(localStorage.getItem(storageKey(areaId)) || "[]");
  } catch { return []; }
}

function setData(areaId, data) {
  localStorage.setItem(storageKey(areaId), JSON.stringify(data));
}

function getAllData() {
  let all = {};
  AREAS.forEach(a => { all[a.id] = getData(a.id); });
  return all;
}

// ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goBack(to) {
  showScreen(to);
  if (to === 'screen-main') renderAreaList();
  if (to === 'screen-area') { renderRecords(); updateAreaBar(); }
}

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
function enterSession() {
  const val = document.getElementById('session-input').value.trim().toUpperCase();
  if (!val) { showToast('Ingres√° un c√≥digo de sesi√≥n', 'error'); return; }
  if (/\s/.test(val)) { showToast('Sin espacios en el c√≥digo', 'error'); return; }

  session = val;
  startApp();
}

function randomSession() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  document.getElementById('session-input').value = code;
  enterSession();
}

function changeSession() {
  session = "";
  document.getElementById('session-input').value = '';
  showScreen('screen-login');
}

function startApp() {
  loadCustomCatalog();
  document.getElementById('main-session-label').textContent = session;
  document.getElementById('main-session-val').textContent = session;
  renderAreaList();
  updateDatalist();
  showScreen('screen-main');
}

// ‚îÄ‚îÄ AREA LIST ‚îÄ‚îÄ
function renderAreaList() {
  const list = document.getElementById('area-list');
  list.innerHTML = '';
  AREAS.forEach(area => {
    const records = getData(area.id);
    const totalKg = records.reduce((s, r) => s + (r.totalKg || 0), 0);
    const count = records.length;
    const div = document.createElement('div');
    div.className = 'area-item';
    div.onclick = () => openArea(area);
    div.innerHTML = `
      <div class="area-item-left">
        <span class="area-icon">${area.icon}</span>
        <div>
          <div class="area-name">${area.name}</div>
          <div class="area-sub">${count > 0 ? count + ' registro' + (count !== 1 ? 's' : '') : 'Sin registros'}</div>
        </div>
      </div>
      <div class="area-right">
        <span class="area-kg ${totalKg === 0 ? 'zero' : ''}">${totalKg > 0 ? totalKg.toFixed(1) + ' kg' : '‚Äî'}</span>
        <span class="chevron">‚Ä∫</span>
      </div>`;
    list.appendChild(div);
  });
}

// ‚îÄ‚îÄ OPEN AREA ‚îÄ‚îÄ
function openArea(area) {
  currentArea = area;
  document.getElementById('area-title').textContent = area.name;
  renderRecords();
  updateAreaBar();
  qfReset();
  showScreen('screen-area');
}

function updateAreaBar() {
  const records = getData(currentArea.id);
  const totalKg = records.reduce((s, r) => s + (r.totalKg || 0), 0);
  document.getElementById('area-kg-bar').textContent = totalKg.toFixed(1) + ' kg';
  document.getElementById('area-totals').textContent =
    `${records.length} items ¬∑ ${totalKg.toFixed(1)} kg total`;
}

// ‚îÄ‚îÄ RECORDS RENDER ‚îÄ‚îÄ
function renderRecords() {
  const records = getData(currentArea.id);
  const container = document.getElementById('record-list');
  if (records.length === 0) {
    container.innerHTML = `<div class="empty-state"><p>Sin registros</p><p>Dict√° o carg√° manualmente</p></div>`;
    return;
  }
  container.innerHTML = '';
  records.forEach((r, i) => {
    const div = document.createElement('div');
    div.className = 'record-item';
    div.innerHTML = `
      <div>
        <div class="record-prod">${r.producto}</div>
        <div class="record-envase">${r.envase}</div>
      </div>
      <div class="record-qty">${r.cantidad} env.</div>
      <div class="record-kg">${(r.totalKg||0).toFixed(1)} kg</div>
      <button class="record-del" onclick="deleteRecord(${i})">‚úï</button>`;
    container.appendChild(div);
  });
}

function deleteRecord(idx) {
  const records = getData(currentArea.id);
  records.splice(idx, 1);
  setData(currentArea.id, records);
  renderRecords();
  updateAreaBar();
}

// ‚îÄ‚îÄ MANUAL FORM (replaced by quick-form) ‚îÄ‚îÄ

// addRecord replaced by qfSave()

function doAddRecord(producto, envase, cantidad, kgenv) {
  const totalKg = cantidad * kgenv;
  // Si el producto no est√° en el cat√°logo, guardarlo para futuras sesiones
  addToCatalog(producto);
  const records = getData(currentArea.id);
  records.push({ producto, envase, cantidad, kgenv, totalKg, ts: Date.now() });
  setData(currentArea.id, records);
  renderRecords();
  updateAreaBar();
  resetForm();
  showToast(`‚úì ${producto} agregado (${totalKg.toFixed(1)} kg)`, 'success');

}

// ‚îÄ‚îÄ PRODUCT VALIDATION ‚îÄ‚îÄ
function normalize(s) {
  return s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim();
}

function findProductMatch(input) {
  const ni = normalize(input);
  // Coincidencia exacta ‚Üí retornar el producto del cat√°logo
  const exact = CATALOG.find(p => normalize(p) === ni);
  if (exact) return exact;
  // Coincidencia parcial ‚Üí retornar null para indicar "hay sugerencias pero no exacto"
  const partial = CATALOG.find(p => normalize(p).includes(ni) || ni.includes(normalize(p)));
  if (partial) return null;
  // Sin ninguna coincidencia ‚Üí retornar undefined para indicar "sin sugerencias"
  return undefined;
}

function getFuzzySuggestions(input) {
  const ni = normalize(input);
  const words = ni.split(/\s+/);
  return CATALOG.filter(p => {
    const np = normalize(p);
    return words.some(w => np.includes(w)) || np.includes(ni) || ni.includes(np);
  }).slice(0, 5);
}

// ‚îÄ‚îÄ DIALOG ‚îÄ‚îÄ
function showProductDialog(original, suggestions, cb, customMsg) {
  dialogCallback = cb;
  document.getElementById('dialog-title').textContent = '‚ö† Confirmar producto';
  document.getElementById('dialog-msg').textContent = customMsg ||
    `"${original}" no est√° en el cat√°logo.${suggestions.length > 0 ? ' ¬øQuisiste decir alguno de estos?' : ''}`;
  const opts = document.getElementById('dialog-options');
  opts.innerHTML = '';
  suggestions.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.className = 'dialog-option';
    btn.innerHTML = `<span class="num">${i + 1}.</span> ${s}`;
    btn.onclick = () => { closeDialog(); cb(s); };
    opts.appendChild(btn);
  });
  document.getElementById('dialog-overlay').classList.add('open');
}

function closeDialog() {
  document.getElementById('dialog-overlay').classList.remove('open');
}

function confirmDialogNew() {
  closeDialog();
  if (dialogCallback) dialogCallback(null);
}


// ‚îÄ‚îÄ ENVASE SUGGESTIONS ‚îÄ‚îÄ
const ENVASE_CATALOG = [
  "Reja 15 kg","Reja 20 kg","Reja 25 kg","Caja 10 kg","Caja 15 kg","Caja 20 kg",
  "Bolsa 20 kg","Bolsa 25 kg","Bolsa 30 kg","Bulto 50 kg","Costal 25 kg",
  "Costal 50 kg","Canasta","Directo","Pallet","Malla 1 kg","Malla 2 kg","Malla 5 kg"
];

// ‚îÄ‚îÄ AUTOCOMPLETE ‚îÄ‚îÄ
let acSelected = { producto: -1, envase: -1 };
let acItems = { producto: [], envase: [] };

function acFilter(field) {
  const input = document.getElementById(field === 'producto' ? 'qf-producto' : 'qf-envase');
  const dropdown = document.getElementById('ac-' + field + '-list');
  const val = input.value.trim();
  const nv = normalize(val);
  const catalog = field === 'producto' ? CATALOG : ENVASE_CATALOG;

  let matches = [];
  if (nv.length === 0) {
    matches = catalog.slice(0, 30);
  } else {
    const starts = catalog.filter(p => normalize(p).startsWith(nv));
    const contains = catalog.filter(p => !normalize(p).startsWith(nv) && normalize(p).includes(nv));
    matches = [...starts, ...contains].slice(0, 10);
  }

  acItems[field] = matches;
  acSelected[field] = -1;
  dropdown.innerHTML = '';

  matches.forEach((item) => {
    const div = document.createElement('div');
    div.className = 'ac-item';
    if (nv.length > 0) {
      const ni = normalize(item);
      const idx = ni.indexOf(nv);
      if (idx >= 0) {
        div.innerHTML = item.substring(0, idx) +
          '<mark>' + item.substring(idx, idx + val.length) + '</mark>' +
          item.substring(idx + val.length);
      } else {
        div.textContent = item;
      }
    } else {
      div.textContent = item;
    }
    div.onmousedown = (e) => { e.preventDefault(); acSelect(field, item); };
    dropdown.appendChild(div);
  });

  if (field === 'producto' && val.length > 0) {
    const exactMatch = CATALOG.find(p => normalize(p) === nv);
    if (!exactMatch) {
      const div = document.createElement('div');
      div.className = 'ac-item ac-item-new';
      div.innerHTML = '&#x2295; Agregar "<strong>' + val + '</strong>" como producto nuevo';
      div.onmousedown = (e) => { e.preventDefault(); acSelectNew(val); };
      dropdown.appendChild(div);
    }
    const badge = document.getElementById('qf-new-badge');
    if (badge) badge.style.display = exactMatch ? 'none' : 'block';
  }

  dropdown.classList.toggle('open', dropdown.children.length > 0);
}

function acSelect(field, value) {
  const input = document.getElementById(field === 'producto' ? 'qf-producto' : 'qf-envase');
  input.value = value;
  document.getElementById('ac-' + field + '-list').classList.remove('open');
  if (field === 'producto') {
    const badge = document.getElementById('qf-new-badge');
    if (badge) badge.style.display = 'none';
    setTimeout(() => document.getElementById('qf-envase').focus(), 50);
  } else {
    setTimeout(() => document.getElementById('qf-cant').focus(), 50);
  }
}

function acSelectNew(value) {
  document.getElementById('qf-producto').value = value;
  document.getElementById('ac-producto-list').classList.remove('open');
  const badge = document.getElementById('qf-new-badge');
  if (badge) badge.style.display = 'block';
  setTimeout(() => document.getElementById('qf-envase').focus(), 50);
}

function acBlur(field) {
  setTimeout(() => {
    document.getElementById('ac-' + field + '-list').classList.remove('open');
    if (field === 'producto') {
      const val = document.getElementById('qf-producto').value.trim();
      const badge = document.getElementById('qf-new-badge');
      if (badge) {
        if (!val) { badge.style.display = 'none'; return; }
        const exactMatch = CATALOG.find(p => normalize(p) === normalize(val));
        badge.style.display = exactMatch ? 'none' : 'block';
      }
    }
  }, 150);
}

document.addEventListener('keydown', (e) => {
  for (const field of ['producto', 'envase']) {
    const input = document.getElementById(field === 'producto' ? 'qf-producto' : 'qf-envase');
    if (!input || document.activeElement !== input) continue;
    const dropdown = document.getElementById('ac-' + field + '-list');
    if (!dropdown || !dropdown.classList.contains('open')) continue;
    const items = dropdown.querySelectorAll('.ac-item');
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      acSelected[field] = Math.min(acSelected[field] + 1, items.length - 1);
      items.forEach((el, i) => el.classList.toggle('selected', i === acSelected[field]));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      acSelected[field] = Math.max(acSelected[field] - 1, -1);
      items.forEach((el, i) => el.classList.toggle('selected', i === acSelected[field]));
    } else if (e.key === 'Enter' && acSelected[field] >= 0) {
      e.preventDefault();
      items[acSelected[field]].onmousedown({ preventDefault: () => {} });
    } else if (e.key === 'Escape') {
      dropdown.classList.remove('open');
    }
  }
});

// ‚îÄ‚îÄ QUICK FORM ‚îÄ‚îÄ
function qfCalc() {
  const cant = parseFloat(document.getElementById('qf-cant').value) || 0;
  const kg = parseFloat(document.getElementById('qf-kgenv').value) || 0;
  const total = cant * kg;
  document.getElementById('qf-total').textContent = total > 0 ? total.toFixed(1) + ' kg' : '0 kg';
}

function qfReset() {
  ['qf-producto','qf-envase','qf-cant','qf-kgenv'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const tot = document.getElementById('qf-total');
  if (tot) tot.textContent = '0 kg';
  const badge = document.getElementById('qf-new-badge');
  if (badge) badge.style.display = 'none';
  ['ac-producto-list','ac-envase-list'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('open');
  });
}

function qfSave() {
  const prod   = (document.getElementById('qf-producto').value || '').trim();
  const envase = (document.getElementById('qf-envase').value || '').trim();
  const cant   = parseFloat(document.getElementById('qf-cant').value) || 0;
  const kgenv  = parseFloat(document.getElementById('qf-kgenv').value) || 0;

  if (!prod)      { showToast('Ingres√° un producto', 'error');                   document.getElementById('qf-producto').focus(); return; }
  if (!envase)    { showToast('Ingres√° el tipo de envase', 'error');             document.getElementById('qf-envase').focus();  return; }
  if (cant <= 0)  { showToast('Cantidad debe ser mayor a 0', 'error');           document.getElementById('qf-cant').focus();    return; }
  if (kgenv <= 0) { showToast('Peso por envase debe ser mayor a 0', 'error');    document.getElementById('qf-kgenv').focus();   return; }

  doAddRecord(prod, envase, cant, kgenv);
  qfReset();
  setTimeout(() => document.getElementById('qf-producto').focus(), 100);
}

function stopMic() {}
function setMicUI() {}


// ‚îÄ‚îÄ SUMMARY GLOBAL ‚îÄ‚îÄ
function goToSummary() {
  renderGlobalSummary();
  showScreen('screen-summary');
}

function renderGlobalSummary() {
  const allData = getAllData();
  // Aggregate by product
  const agg = {};
  AREAS.forEach(area => {
    allData[area.id].forEach(r => {
      if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
      agg[r.producto].envases += r.cantidad;
      agg[r.producto].totalKg += r.totalKg || 0;
    });
  });

  const tbody = document.getElementById('global-tbody');
  tbody.innerHTML = '';
  const prods = Object.keys(agg).sort();
  if (prods.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:var(--text3);padding:20px;">Sin datos</td></tr>';
    return;
  }
  let totalEnv = 0, totalKg = 0;
  prods.forEach(prod => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${prod}</td><td class="num">${agg[prod].envases}</td><td class="num">${agg[prod].totalKg.toFixed(1)}</td>`;
    tbody.appendChild(row);
    totalEnv += agg[prod].envases;
    totalKg += agg[prod].totalKg;
  });
  const totRow = document.createElement('tr');
  totRow.className = 'total-row';
  totRow.innerHTML = `<td>TOTAL</td><td class="num">${totalEnv}</td><td class="num">${totalKg.toFixed(1)}</td>`;
  tbody.appendChild(totRow);
}

// ‚îÄ‚îÄ SUMMARY BY AREA ‚îÄ‚îÄ
function goToSummaryByArea() {
  renderAreaSummary();
  showScreen('screen-summary-area');
}

function renderAreaSummary() {
  const container = document.getElementById('area-summary-content');
  container.innerHTML = '';
  AREAS.forEach(area => {
    const records = getData(area.id);
    if (records.length === 0) return;
    const agg = {};
    records.forEach(r => {
      if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
      agg[r.producto].envases += r.cantidad;
      agg[r.producto].totalKg += r.totalKg || 0;
    });

    const totalKg = records.reduce((s,r) => s + (r.totalKg||0), 0);
    const section = document.createElement('div');
    section.style.marginBottom = '24px';
    section.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:700;font-size:13px;">${area.icon} ${area.name}</div>
        <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--accent);">${totalKg.toFixed(1)} kg total</div>
      </div>
      <table class="summary-table">
        <thead><tr><th>Producto</th><th style="text-align:right">Envases</th><th style="text-align:right">Total kg</th></tr></thead>
        <tbody>
          ${Object.keys(agg).sort().map(p =>
            `<tr><td>${p}</td><td class="num">${agg[p].envases}</td><td class="num">${agg[p].totalKg.toFixed(1)}</td></tr>`
          ).join('')}
        </tbody>
      </table>`;
    container.appendChild(section);
  });
  if (container.innerHTML === '') {
    container.innerHTML = '<p style="color:var(--text3);text-align:center;padding:30px;font-size:13px;">Sin datos en ning√∫n √°rea</p>';
  }
}

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ
function exportExcel(mode) {
  const wb = XLSX.utils.book_new();

  if (mode === 'global') {
    const allData = getAllData();
    const agg = {};
    AREAS.forEach(area => {
      allData[area.id].forEach(r => {
        if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
        agg[r.producto].envases += r.cantidad;
        agg[r.producto].totalKg += r.totalKg || 0;
      });
    });
    const rows = [['Producto', 'Envases', 'Total kg']];
    let te = 0, tk = 0;
    Object.keys(agg).sort().forEach(p => {
      rows.push([p, agg[p].envases, parseFloat(agg[p].totalKg.toFixed(1))]);
      te += agg[p].envases; tk += agg[p].totalKg;
    });
    rows.push(['TOTAL', te, parseFloat(tk.toFixed(1))]);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, 'Global');
    XLSX.writeFile(wb, `inventario_global_${session}.xlsx`);

  } else {
    AREAS.forEach(area => {
      const records = getData(area.id);
      if (records.length === 0) return;
      const agg = {};
      records.forEach(r => {
        if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
        agg[r.producto].envases += r.cantidad;
        agg[r.producto].totalKg += r.totalKg || 0;
      });
      const rows = [['Producto', 'Envases', 'Total kg']];
      let te = 0, tk = 0;
      Object.keys(agg).sort().forEach(p => {
        rows.push([p, agg[p].envases, parseFloat(agg[p].totalKg.toFixed(1))]);
        te += agg[p].envases; tk += agg[p].totalKg;
      });
      rows.push(['TOTAL', te, parseFloat(tk.toFixed(1))]);
      const ws = XLSX.utils.aoa_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, area.name.substring(0, 31));
    });
    if (wb.SheetNames.length === 0) { showToast('Sin datos para exportar', 'error'); return; }
    XLSX.writeFile(wb, `inventario_por_area_${session}.xlsx`);
  }
  showToast('‚úì Excel descargado', 'success');
}

function exportPDF(mode) {
  const win = window.open('', '_blank');
  let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; color: #111; }
    h1 { font-size: 20px; margin-bottom: 4px; }
    h2 { font-size: 14px; margin: 20px 0 6px; color: #444; border-bottom: 1px solid #ddd; padding-bottom: 4px; }
    p { font-size: 11px; color: #888; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 12px; }
    th { background: #f0f0f0; padding: 7px 10px; text-align: left; border: 1px solid #ddd; }
    td { padding: 6px 10px; border: 1px solid #ddd; }
    .num { text-align: right; }
    .total { font-weight: bold; background: #f8f8f8; }
    @media print { button { display: none; } }
  </style></head><body>`;

  const date = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'long', year:'numeric' });

  if (mode === 'global') {
    html += `<h1>üì¶ Inventario ‚Äî Resumen Global</h1><p>Sesi√≥n: ${session} ¬∑ ${date}</p>`;
    const allData = getAllData();
    const agg = {};
    AREAS.forEach(area => {
      allData[area.id].forEach(r => {
        if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
        agg[r.producto].envases += r.cantidad;
        agg[r.producto].totalKg += r.totalKg || 0;
      });
    });
    html += `<table><thead><tr><th>Producto</th><th class="num">Envases</th><th class="num">Total kg</th></tr></thead><tbody>`;
    let te = 0, tk = 0;
    Object.keys(agg).sort().forEach(p => {
      html += `<tr><td>${p}</td><td class="num">${agg[p].envases}</td><td class="num">${agg[p].totalKg.toFixed(1)}</td></tr>`;
      te += agg[p].envases; tk += agg[p].totalKg;
    });
    html += `<tr class="total"><td>TOTAL</td><td class="num">${te}</td><td class="num">${tk.toFixed(1)}</td></tr>`;
    html += `</tbody></table>`;
  } else {
    html += `<h1>üì¶ Inventario ‚Äî Resumen por √Årea</h1><p>Sesi√≥n: ${session} ¬∑ ${date}</p>`;
    AREAS.forEach(area => {
      const records = getData(area.id);
      if (records.length === 0) return;
      const agg = {};
      records.forEach(r => {
        if (!agg[r.producto]) agg[r.producto] = { envases: 0, totalKg: 0 };
        agg[r.producto].envases += r.cantidad;
        agg[r.producto].totalKg += r.totalKg || 0;
      });
      const totalKg = records.reduce((s,r) => s + (r.totalKg||0), 0);
      html += `<h2>${area.icon} ${area.name} ‚Äî ${totalKg.toFixed(1)} kg total</h2>`;
      html += `<table><thead><tr><th>Producto</th><th class="num">Envases</th><th class="num">Total kg</th></tr></thead><tbody>`;
      let te = 0, tk = 0;
      Object.keys(agg).sort().forEach(p => {
        html += `<tr><td>${p}</td><td class="num">${agg[p].envases}</td><td class="num">${agg[p].totalKg.toFixed(1)}</td></tr>`;
        te += agg[p].envases; tk += agg[p].totalKg;
      });
      html += `<tr class="total"><td>TOTAL</td><td class="num">${te}</td><td class="num">${tk.toFixed(1)}</td></tr>`;
      html += `</tbody></table>`;
    });
  }

  html += `<button onclick="window.print()">üñ® Imprimir / Guardar PDF</button>
</body></html>`;
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 600);
}

// ‚îÄ‚îÄ CLEAR ‚îÄ‚îÄ
function clearAll() {
  if (!confirm('¬øBorrar TODO el inventario de la sesi√≥n ' + session + '? Esta acci√≥n no se puede deshacer.')) return;
  AREAS.forEach(a => setData(a.id, []));
  renderGlobalSummary();
  showToast('‚úì Inventario borrado', 'success');
}

function clearByArea() {
  const names = AREAS.map((a, i) => `${i+1}. ${a.name}`).join('\n');
  const input = prompt('¬øQu√© √°rea borrar? Ingres√° el n√∫mero:\n\n' + names);
  const num = parseInt(input);
  if (isNaN(num) || num < 1 || num > AREAS.length) { showToast('N√∫mero inv√°lido', 'error'); return; }
  const area = AREAS[num - 1];
  if (!confirm(`¬øBorrar todos los registros de "${area.name}"?`)) return;
  setData(area.id, []);
  renderAreaSummary();
  showToast(`‚úì ${area.name} borrada`, 'success');
}

// ‚îÄ‚îÄ CATALOG IMPORT ‚îÄ‚îÄ
function importCatalog(event) {
  const file = event.target.files[0];
  if (!file) return;

  if (file.name.endsWith('.xlsx')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const wb = XLSX.read(e.target.result, { type: 'binary' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
      const products = [];
      data.forEach(row => {
        if (row[0] && typeof row[0] === 'string' && row[0].toLowerCase() !== 'producto') {
          products.push(row[0].trim());
        }
      });
      if (products.length > 0) {
        CATALOG = products;
        updateDatalist();
        showToast(`‚úì Cat√°logo importado: ${products.length} productos`, 'success');
      } else {
        showToast('No se encontraron productos en el archivo', 'error');
      }
    };
    reader.readAsBinaryString(file);
  } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const lines = e.target.result.split(/\r?\n/).map(l => l.trim()).filter(l => l && l.toLowerCase() !== 'producto');
      if (lines.length > 0) {
        CATALOG = lines;
        updateDatalist();
        showToast(`‚úì Cat√°logo importado: ${lines.length} productos`, 'success');
      }
    };
    reader.readAsText(file);
  }

  event.target.value = '';
}

function updateDatalist() {
  const dl = document.getElementById('prod-datalist');
  dl.innerHTML = '';
  CATALOG.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p;
    dl.appendChild(opt);
  });
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
let toastTimeout;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => { t.classList.remove('show'); }, 2800);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.getElementById('session-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') enterSession();
});

// Check saved session
const savedSession = localStorage.getItem('inv_last_session');
if (savedSession) {
  document.getElementById('session-input').value = savedSession;
}

// Save session on enter
window.enterSession = function() {
  const val = document.getElementById('session-input').value.trim().toUpperCase();
  if (val) localStorage.setItem('inv_last_session', val);
  if (!val) { showToast('Ingres√° un c√≥digo de sesi√≥n', 'error'); return; }
  if (/\s/.test(val)) { showToast('Sin espacios en el c√≥digo', 'error'); return; }
  session = val;
  startApp();
};

</script>
</body>
</html>
